name: Full Stack CI/CD

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:
    inputs:
      backend_version:
        description: Custom tag suffix for backend (defaults to run number)
        required: false
      frontend_version:
        description: Custom tag suffix for frontend (defaults to run number)
        required: false

jobs:
  backend-build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: maven
      - name: Build and test
        run: ./mvnw clean verify

  frontend-build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: frontend/package-lock.json
      - run: npm ci
      - name: Run frontend unit tests
        run: npm test
      - run: npm run build -- --configuration production

  e2e:
    runs-on: ubuntu-latest
    needs: backend-build
    services:
      postgres:
        image: postgres:16
        ports:
          - 5432:5432
        env:
          POSTGRES_DB: demo
          POSTGRES_USER: admin
          POSTGRES_PASSWORD: demo
        options: >-
          --health-cmd "pg_isready -U admin -d demo"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 10
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: backend/package-lock.json
      - name: Install PostgreSQL client tools
        run: sudo apt-get update && sudo apt-get install -y postgresql-client
      - name: Install e2e dependencies
        run: npm ci
      - name: Wait for PostgreSQL
        env:
          PGPASSWORD: demo
        run: |
          for _ in {1..30}; do
            if pg_isready -h 127.0.0.1 -p 5432 -U admin >/dev/null 2>&1; then
              echo "PostgreSQL is ready"
              exit 0
            fi
            sleep 2
          done
          echo "PostgreSQL failed to become ready" >&2
          exit 1
      - name: Build backend Docker image for e2e
        run: docker build -t backend-e2e:${{ github.sha }} .
      - name: Seed database
        env:
          SPRING_PROFILES_ACTIVE: dev
        run: |
          docker run --rm --network host \
            -e SPRING_PROFILES_ACTIVE=$SPRING_PROFILES_ACTIVE \
            -e CI=true \
            backend-e2e:${{ github.sha }} --seed-data
      - name: Start backend container
        env:
          SPRING_PROFILES_ACTIVE: dev
        run: |
          docker run -d --name backend-e2e \
            --network host \
            -e SPRING_PROFILES_ACTIVE=$SPRING_PROFILES_ACTIVE \
            backend-e2e:${{ github.sha }}
      - name: Wait for backend readiness
        run: |
          for _ in {1..60}; do
            if curl -fsS http://127.0.0.1:8080/actuator/health >/dev/null; then
              echo "Backend is ready"
              exit 0
            fi
            sleep 2
          done
          echo "Backend failed to become ready" >&2
          docker logs backend-e2e >&2 || true
          exit 1
      - name: Run e2e tests
        run: npm run test:e2e
      - name: Collect backend logs
        if: failure()
        working-directory: .
        run: docker logs backend-e2e > backend-e2e.log || true
      - name: Upload backend logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: backend-e2e-logs
          path: backend-e2e.log
      - name: Stop backend
        if: always()
        working-directory: .
        run: |
          if docker ps -a --format '{{.Names}}' | grep -Eq '^backend-e2e$'; then
            docker rm -f backend-e2e || true
          fi

  deploy:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs:
      - backend-build
      - frontend-build
      - e2e
    environment: main
    env:
      DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USER }}
      DOCKERHUB_PASS: ${{ secrets.DOCKERHUB_PASS }}
      KUBECONFIG_FILE: kubeconfig
      SEALED_POSTGRES_USER: ${{ secrets.SEALED_POSTGRES_USER }}
      SEALED_POSTGRES_PASSWORD: ${{ secrets.SEALED_POSTGRES_PASSWORD }}
    steps:
      - uses: actions/checkout@v4
      - name: Prepare version suffixes
        run: |
          backend_suffix="${{ github.event.inputs.backend_version || github.run_number }}"
          frontend_suffix="${{ github.event.inputs.frontend_version || github.run_number }}"
          echo "BACKEND_SUFFIX=$backend_suffix" >> $GITHUB_ENV
          echo "FRONTEND_SUFFIX=$frontend_suffix" >> $GITHUB_ENV
      - name: Determine backend version prefix
        run: |
          if [ ! -f backend/VERSION ]; then
            echo "backend/VERSION file not found" >&2
            exit 1
          fi
          prefix=$(tr -d ' \t\r\n' < backend/VERSION)
          if [ -z "$prefix" ]; then
            echo "Failed to determine backend version prefix" >&2
            exit 1
          fi
          echo "BACKEND_VERSION=${prefix}-${BACKEND_SUFFIX}" >> $GITHUB_ENV
      - name: Determine frontend version prefix
        run: |
          if [ ! -f frontend/VERSION ]; then
            echo "frontend/VERSION file not found" >&2
            exit 1
          fi
          prefix=$(tr -d ' \t\r\n' < frontend/VERSION)
          if [ -z "$prefix" ]; then
            echo "Failed to determine frontend version prefix" >&2
            exit 1
          fi
          echo "FRONTEND_VERSION=${prefix}-${FRONTEND_SUFFIX}" >> $GITHUB_ENV
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USER }}
          password: ${{ env.DOCKERHUB_PASS }}
      - name: Build backend image
        run: docker build -t "$DOCKERHUB_USER/my-template-backend:$BACKEND_VERSION" ./backend
      - name: Push backend image
        run: |
          docker push $DOCKERHUB_USER/my-template-backend:$BACKEND_VERSION
          docker tag $DOCKERHUB_USER/my-template-backend:$BACKEND_VERSION $DOCKERHUB_USER/my-template-backend:latest
          docker push $DOCKERHUB_USER/my-template-backend:latest
      - name: Build frontend image
        run: docker build -t "$DOCKERHUB_USER/my-template-frontend:$FRONTEND_VERSION" ./frontend
      - name: Push frontend image
        run: |
          docker push $DOCKERHUB_USER/my-template-frontend:$FRONTEND_VERSION
          docker tag $DOCKERHUB_USER/my-template-frontend:$FRONTEND_VERSION $DOCKERHUB_USER/my-template-frontend:latest
          docker push $DOCKERHUB_USER/my-template-frontend:latest
      # TODO: dokončiť - https://chatgpt.com/c/691a3340-e6f4-832c-a7ad-e37fc145702e , https://chatgpt.com/c/69217708-4424-8327-9f20-a4d6b54b888b
      #- name: Setup Helm
      #  uses: azure/setup-helm@v4
      #- name: Configure kubectl
      #  run: |
      #    echo "${{ secrets.KUBECONFIG_DATA }}" | base64 --decode > $KUBECONFIG_FILE
      #    echo "KUBECONFIG=$KUBECONFIG_FILE" >> $GITHUB_ENV
      #- name: Deploy with Helm
      #  run: |
      #    helm upgrade --install my-template ./charts/my-template \
      #      --namespace my-template \
      #      --create-namespace \
      #      --set backend.image=$DOCKERHUB_USER/my-template-backend \
      #      --set backend.tag=$BACKEND_VERSION \
      #      --set frontend.image=$DOCKERHUB_USER/my-template-frontend \
      #      --set frontend.tag=$FRONTEND_VERSION \
      #      --set-string postgres.sealedUser="$SEALED_POSTGRES_USER" \
      #      --set-string postgres.sealedPassword="$SEALED_POSTGRES_PASSWORD"
